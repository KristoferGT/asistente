#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ            ๐ฅ FIREWALLD - APERTURA DE PUERTOS TCP/UDP              โ
# โ            ๐พ Autor: ChristopherAGT - Guatemalteco ๐ฌ๐น              โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# ๐ Requiere permisos de superusuario
if [ "$EUID" -ne 0 ]; then
  echo -e "\n\033[1;31m๐ซ Este script debe ejecutarse como root o con sudo.\033[0m"
  exit 1
fi

# ๐จ Colores
verde="\033[1;32m"
rojo="\033[1;31m"
azul="\033[1;34m"
amarillo="\033[1;33m"
neutro="\033[0m"

# ๐ Spinner animado
spinner() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\'
  tput civis
  while ps -p $pid &>/dev/null; do
    local temp=${spinstr#?}
    printf " [%c]  " "$spinstr"
    spinstr=$temp${spinstr%"$temp"}
    sleep $delay
    printf "\b\b\b\b\b\b"
  done
  tput cnorm
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${azul}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐  ACTUALIZANDO LISTA DE PAQUETES DEL SISTEMA"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

apt-get update -y &> /dev/null &
spinner $!
echo -e "${verde}โ Lista de paquetes actualizada.${neutro}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${azul}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ฆ  VERIFICANDO INSTALACIรN DE FIREWALLD"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

if ! command -v firewall-cmd &> /dev/null; then
  echo -e "${amarillo}๐ฆ firewalld no estรก instalado. Instalando...${neutro}"
  apt-get install -y firewalld &> /dev/null &
  spinner $!
  if ! command -v firewall-cmd &> /dev/null; then
    echo -e "${rojo}โ La instalaciรณn de firewalld fallรณ. Abortando.${neutro}"
    exit 1
  fi
  echo -e "${verde}โ firewalld instalado correctamente.${neutro}"
else
  echo -e "${verde}โ firewalld ya estรก instalado.${neutro}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${azul}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐  INICIANDO Y HABILITANDO FIREWALLD"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

systemctl enable firewalld &> /dev/null
systemctl start firewalld

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${amarillo}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐  ASEGURANDO CONEXIรN SSH (22/TCP)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

# ๐ Mantener siempre SSH abierto
firewall-cmd --zone=public --permanent --add-port=22/tcp

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${amarillo}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ๏ธ  ยกATENCIรN! APERTURA TOTAL DE PUERTOS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"
echo -e "๐ Estรกs a punto de abrir *TODOS* los puertos TCP y UDP (1-65535).\n"
while true; do
  read -p "ยฟDeseas continuar? [s/n]: " confirm
  case "$confirm" in
    [sS]) break ;;  # Continua el script
    [nN]|"") echo -e "${rojo}โ Operaciรณn cancelada por el usuario.${neutro}"; exit 1 ;;
    *) echo -e "${amarillo}โ๏ธ Respuesta no vรกlida. Ingresa 's' para sรญ o 'n' para no.${neutro}" ;;
  esac
done

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${azul}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐  VERIFICANDO PUERTOS ACTUALMENTE ABIERTOS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

if firewall-cmd --zone=public --list-ports | grep -q "1-65535/tcp"; then
  echo -e "${amarillo}โ๏ธ Los puertos TCP ya estรกn abiertos.${neutro}"
else
  echo -e "${amarillo}๐ Abriendo puertos TCP...${neutro}"
  firewall-cmd --zone=public --permanent --add-port=1-65535/tcp
fi

if firewall-cmd --zone=public --list-ports | grep -q "1-65535/udp"; then
  echo -e "${amarillo}โ๏ธ Los puertos UDP ya estรกn abiertos.${neutro}"
else
  echo -e "${amarillo}๐ Abriendo puertos UDP...${neutro}"
  firewall-cmd --zone=public --permanent --add-port=1-65535/udp
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${azul}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โป๏ธ  REINICIANDO CONFIGURACIรN FIREWALLD"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

firewall-cmd --reload

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${verde}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐  PUERTOS ABIERTOS EN ZONA 'public'"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${neutro}"

firewall-cmd --zone=public --list-ports

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "${verde}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  CONFIGURACIรN COMPLETADA CON รXITO"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${amarillo}โ๏ธ Recuerda: abrir todos los puertos es riesgoso. รsalo sรณlo en entornos seguros.${neutro}\n"
